import{d as e,_ as s,r as a,u as t,w as l,e as r,a as o,f as n,g as i,h as u,c as d,i as c,j as p,t as m,k as w,s as g,l as f,m as v,n as h,p as y,b,q as _,E as k,v as C,x as M,y as j,z as L,A as V,B as x}from"./index-96f101f2.js";import{u as z,a as P}from"./useCommon-ceabe716.js";import{W as U}from"./web3.min-4221e9b3.js";e({name:"Login"});const q=""+new URL("../svg/mall3-0d915552.svg",import.meta.url).href,N=e=>(j("data-v-1b980143"),e=e(),L(),e),Q={class:"login-container columnCC"},A=N((()=>p("img",{src:q,alt:"Mall3"},null,-1))),R={class:"title-container"},K={class:"title text-center"},S=b("用户名登录"),W={class:"rowSC"},B={class:"svg-container"},E=N((()=>p("div",{class:"show-pwd"},null,-1))),F={class:"rowSC flex-1"},I={class:"svg-container"},O=b(" 登陆 "),Y=b("Web3钱包登录"),D=b(" MetaMask钱包登陆 "),G=s({__name:"login-web3",setup(e){let s;const b=z().formRules;let j=a({username:"",password:""}),L=a({otherQuery:{},redirect:void 0});const V=t();l((()=>V.query),(e=>{e&&(L.redirect=e.redirect,L.otherQuery=(e=>Object.keys(e).reduce(((s,a)=>("redirect"!==a&&(s[a]=e[a]),s)),{}))(e))}),{immediate:!0});let x=r(!1),q=r(!1);const N=r(null);let G=()=>{N.value.validate((e=>{if(!e)return!1;J()}))};const H=o();let J=()=>{x.value=!0;_().login(j).then((()=>{k({message:"Login successfully",type:"success"}),H.push({path:L.redirect||"/",query:L.otherQuery})})).catch((e=>{k({message:e.message,type:"error",duration:3e3}),P().sleep(30).then((()=>{x.value=!1}))}))},T=async()=>{await X(),q.value=!1},X=async()=>{const e=_();if(q.value=!0,!window.ethereum)return void k({message:"请先安装MetaMask钱包",type:"error",duration:5e3});if(!s)try{await window.ethereum.enable(),s=new U(window.ethereum)}catch(r){return void k({message:"You need to allow MetaMask.",type:"error",duration:5e3})}const a=await s.eth.getCoinbase();if(!a)return void k({message:"Please activate MetaMask first.",type:"error",duration:5e3});const t=a.toLowerCase();let l={url:"/api/mall3/auth/nonce",method:"get",data:{pubAddress:t},isParams:!0};C(l).then((a=>{let o=a.data;o?s.eth.personal.sign(o,t,"").then((s=>{l={url:"/api/mall3/auth/login/web3",method:"post",data:{pubAddress:t,signature:s,nonce:o}},C(l).then((s=>{e.set(s).then((()=>{try{H.push({path:L.redirect||"/",query:L.otherQuery})}catch(r){}}))})).catch((e=>{k({message:e.message,type:"error",duration:3e3}),P().sleep(30).then((()=>{q.value=!1}))}))})):k({message:"无法生成随机字符串",type:"error",duration:5e3})}))},Z=r("password");const $=r(null);let ee=()=>{"password"===Z.value?Z.value="":Z.value="password",M((()=>{$.value.focus()}))};return(e,s)=>{const a=n("el-divider"),t=n("svg-icon"),l=n("el-input"),r=n("el-form-item"),o=n("el-button"),_=n("el-form");return i(),u("div",Q,[A,d(_,{ref_key:"refloginForm",ref:N,class:"login-form",model:w(j),rules:w(b)},{default:c((()=>[p("div",R,[p("h3",K,m(w(g).title),1)]),d(a,{"content-position":"center","border-style":"dashed",class:"divider"},{default:c((()=>[S])),_:1}),d(r,{prop:"username",rules:w(b).isNotNull},{default:c((()=>[p("div",W,[p("span",B,[d(t,{"icon-class":"user"})]),d(l,{modelValue:w(j).username,"onUpdate:modelValue":s[0]||(s[0]=e=>w(j).username=e),placeholder:"Please input name"},null,8,["modelValue"]),f("占位"),E])])),_:1},8,["rules"]),f('<el-form-item prop="password" :rules="formRules.passwordValid">'),d(r,{prop:"password",rules:w(b).isNotNull},{default:c((()=>[p("div",F,[p("span",I,[d(t,{"icon-class":"password"})]),(i(),v(l,{key:w(Z),ref_key:"refPassword",ref:$,modelValue:w(j).password,"onUpdate:modelValue":s[1]||(s[1]=e=>w(j).password=e),type:w(Z),name:"password",placeholder:"Please input password",onKeyup:h(w(G),["enter"])},null,8,["modelValue","type","onKeyup"])),p("span",{class:"show-pwd",onClick:s[2]||(s[2]=(...e)=>w(ee)&&w(ee)(...e))},[d(t,{"icon-class":"password"===w(Z)?"eye":"eye-open"},null,8,["icon-class"])])])])),_:1},8,["rules"]),d(o,{loading:w(x),type:"primary",class:"login-btn",size:"default",onClick:y(w(G),["prevent"])},{default:c((()=>[O])),_:1},8,["loading","onClick"]),d(a,{"content-position":"center","border-style":"dashed",class:"divider",style:{"font-size":"12px"}},{default:c((()=>[Y])),_:1}),d(o,{loading:w(q),type:"success",class:"login-btn",size:"default",onClick:y(w(T),["prevent"])},{default:c((()=>[D])),_:1},8,["loading","onClick"])])),_:1},8,["model","rules"])])}}},[["__scopeId","data-v-1b980143"],["__file","/Users/liuzhaoming/百度云同步盘/mac同步/project/valor/web3/mall/mall3-web/src/views/login/login-web3.vue"]]);e({name:"Login"});const H=s({__name:"Login",setup(e){const s=V((()=>G));return(e,a)=>(i(),v(x(w(s))))}},[["__file","/Users/liuzhaoming/百度云同步盘/mac同步/project/valor/web3/mall/mall3-web/src/views/login/Login.vue"]]);export{H as default};
